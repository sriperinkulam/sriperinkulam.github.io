<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Deploying Known on a docker stack | Srikanth Perinkulam</title>
<meta name=keywords content="docker-build,docker-stack,idno,indieweb,known,php,withknown"><meta name=description content="To migrate my php applications that did not have a handy docker-compose available, I needed a vanilla setup for my stack-based docker environment. Known is one of those apps and so the first step was to build that PHP environment.
Setting up a Dockerhub repository and building a custom PHP image
[If you decide to use my image, you would not have to build this yourself. Skip ahead to the Deploying Known section]"><meta name=author content="map[email:ssphugo@srkn.anonaddy.com name:Srikanth Perinkulam nick:SSP]"><link rel=canonical href=http://localhost:1313/2020/04/28/deploying-known-on-a-docker-stack/><link crossorigin=anonymous href=/assets/css/stylesheet.ff25044c0e8b288ea9887b21a2a2c811d3ae590ca5420e2460193f268288cbaa.css integrity="sha256-/yUETA6LKI6piHshoqLIEdOuWQylQg4kYBk/JoKIy6o=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/2020/04/28/deploying-known-on-a-docker-stack/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=webmention href=https://webmention.io/srikanthperinkulam.com/webmention><link rel=pingback href=https://webmention.io/srikanthperinkulam.com/xmlrpc><script src=/webmention.min.js async></script><script src=https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.1/purify.min.js integrity="sha512-uHOKtSfJWScGmyyFr2O2+efpDx2nhwHU2v7MVeptzZoiC7bdF6Ny/CmZhN2AwIK1oCFiVQQ5DA/L9FSzyPNu6Q==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link href=https://micro.blog/sp rel=me><link rel=webmention href=https://micro.blog/webmention><link rel=authorization_endpoint href=https://micro.blog/indieauth/auth><link rel=token_endpoint href=https://micro.blog/indieauth/token><meta property="og:title" content="Deploying Known on a docker stack"><meta property="og:description" content="To migrate my php applications that did not have a handy docker-compose available, I needed a vanilla setup for my stack-based docker environment. Known is one of those apps and so the first step was to build that PHP environment.
Setting up a Dockerhub repository and building a custom PHP image
[If you decide to use my image, you would not have to build this yourself. Skip ahead to the Deploying Known section]"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/2020/04/28/deploying-known-on-a-docker-stack/"><meta property="og:image" content="http://localhost:1313/images/favicon/apple-touch-icon.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-28T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-28T00:00:00+00:00"><meta property="og:site_name" content="Srikanth Perinkulam"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/images/favicon/apple-touch-icon.png"><meta name=twitter:title content="Deploying Known on a docker stack"><meta name=twitter:description content="To migrate my php applications that did not have a handy docker-compose available, I needed a vanilla setup for my stack-based docker environment. Known is one of those apps and so the first step was to build that PHP environment.
Setting up a Dockerhub repository and building a custom PHP image
[If you decide to use my image, you would not have to build this yourself. Skip ahead to the Deploying Known section]"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"Deploying Known on a docker stack","item":"http://localhost:1313/2020/04/28/deploying-known-on-a-docker-stack/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Deploying Known on a docker stack","name":"Deploying Known on a docker stack","description":"To migrate my php applications that did not have a handy docker-compose available, I needed a vanilla setup for my stack-based docker environment. Known is one of those apps and so the first step was to build that PHP environment.\nSetting up a Dockerhub repository and building a custom PHP image\n[If you decide to use my image, you would not have to build this yourself. Skip ahead to the Deploying Known section]\n","keywords":["docker-build","docker-stack","idno","indieweb","known","php","withknown"],"articleBody":"To migrate my php applications that did not have a handy docker-compose available, I needed a vanilla setup for my stack-based docker environment. Known is one of those apps and so the first step was to build that PHP environment.\nSetting up a Dockerhub repository and building a custom PHP image\n[If you decide to use my image, you would not have to build this yourself. Skip ahead to the Deploying Known section]\nMost php based apps also need specific extensions built-in. While I am sure they’re out there on the Docker hub repository, I was not able to easily find any images that met my specific needs [php extensions for gd, zip, pdo_mysql etc]. So I went ahead and setup my own repository on Docker Hub.\nSomething I learnt today was that a docker stack only accepts pre-built images. Which essentially means you cannot use the regular build command on the fly in your docker-compose file. A quick work-around to that is to build the image locally and then publish it to a public repository from where the stack can easily access it.\nCreate a dockerfile: sudo nano dockerfile Copy over contents from my dockerfile gist. Edit or update if you need any additional extensions. Do note that I am pulling a debian buster image here. An alpine image would be optimal but lets’ run with this for now. Build the image locally: docker build -t sriperinkulam/php-7.4.3-apache-buster-plus:latest . Edit the image and tag name as needed. If your gist file is defined correctly, the image should be ready in a few minutes. It took me a few iterations to get this working with all the extensions I needed and shouldn’t give you any errors during the build process.\nLogin to your Dockerhub repo: docker login Push your image over to your repository: docker push sriperinkulam/php-7.4.3-apache-buster-plus:latest Within a few minutes, your image should be available for easy fetch whenever needed! Setting up and deploying the Known install\nCreate a folder for the known installation: sudo mkdir known \u0026\u0026 cd known\nCopy over my ‘known.yml’ gist from here and paste into a known.yml file. sudo nano known.yml\nThis is where we use the image we built earlier! Make sure you update the passwords there-in.\nCreate an ‘app’ folder. This is where we will copy in the core known package. sudo mkdir app \u0026\u0026 cd app\nMarcus Povey does the heavy lifting of packaging the known install ‘unofficially’. Download his latest pre-packaged release from his portal.\nwget https://withknown.marcus-povey.co.uk/\nFinally unzip/untar the package.\nStep back into the main ‘known’ directory and deploy the stack that we defined in the known.yml file. cd ..\nDOMAIN=known.domain.org SCHEME=https docker stack deploy -c known.yml known\nAssuming you’ve already setup the traefik container, as mentioned in my Jitsi post, you should now have Known up and running. Navigate to the domain and you should see the warmup page.\nKey in the db credentials that you setup in the known.yml file. The database would need to be set as mariadb, since that’s how we’ve defined it in the known.yml file. Also make sure you have the Uploads folder writable by www-data:\nsudo chown -R www-data /var/www/html/Uploads/\nSetup your user account and proceed with the regular administration controls!\n","wordCount":"538","inLanguage":"en","image":"http://localhost:1313/images/favicon/apple-touch-icon.png","datePublished":"2020-04-28T00:00:00Z","dateModified":"2020-04-28T00:00:00Z","author":{"@type":"Person","name":{"email":"ssphugo@srkn.anonaddy.com","name":"Srikanth Perinkulam","nick":"SSP"}},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/2020/04/28/deploying-known-on-a-docker-stack/"},"publisher":{"@type":"Organization","name":"Srikanth Perinkulam","logo":{"@type":"ImageObject","url":"http://localhost:1313/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Srikanth Perinkulam (Alt + H)">Srikanth Perinkulam</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=http://localhost:1313/archives/ title=Archive><span>Archive</span></a></li><li><a href=http://localhost:1313/micro/ title=Micro><span>Micro</span></a></li><li><a href=http://localhost:1313/now/ title=Now><span>Now</span></a></li><li><a href=http://localhost:1313/photos/ title=Photos><span>Photos</span></a></li><li><a href=http://localhost:1313/rewind/ title=Rewind><span>Rewind</span></a></li><li><a href=http://localhost:1313/categories/ title=Categories><span>Categories</span></a></li><li><a href=http://localhost:1313/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Deploying Known on a docker stack</h1><div class=post-meta><span title='2020-04-28 00:00:00 +0000 UTC'>April 28, 2020</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;538 words&nbsp;·&nbsp;map[email:ssphugo@srkn.anonaddy.com name:Srikanth Perinkulam nick:SSP]</div></header><div class=post-content><p>To migrate my php applications that did not have a handy docker-compose available, I needed a vanilla setup for my stack-based docker environment. <a href=https://withknown.com/opensource/>Known</a> is one of those apps and so the first step was to build that PHP environment.</p><p><strong>Setting up a Dockerhub repository and building a custom PHP image</strong></p><p>[If you decide to use my image, you would not have to build this yourself. Skip ahead to the Deploying Known section]</p><p>Most php based apps also need specific extensions built-in. While I am sure they&rsquo;re out there on the Docker hub repository, I was not able to easily find any images that met my specific needs [php extensions for gd, zip, pdo_mysql etc]. So I went ahead and <a href=https://hub.docker.com/r/sriperinkulam/php-7.4.3-apache-buster-plus>setup my own repository on Docker Hub</a>.</p><p>Something I learnt today was that a docker stack only accepts pre-built images. Which essentially means you cannot use the regular <a href=https://docs.docker.com/engine/reference/commandline/build/>build command</a> on the fly in your docker-compose file. A quick work-around to that is to build the image locally and then publish it to a public repository from where the stack can easily access it.</p><ul><li>Create a dockerfile: <code>sudo nano dockerfile</code></li><li>Copy over contents from <a href=https://gist.github.com/sriperinkulam/26d8702d946a8bad22d7623892be816c>my dockerfile gist</a>. Edit or update if you need any additional extensions. Do note that I am pulling a debian buster image here. An alpine image would be optimal but lets&rsquo; run with this for now.</li><li>Build the image locally: <code>docker build -t sriperinkulam/php-7.4.3-apache-buster-plus:latest .</code></li></ul><p>Edit the image and tag name as needed. If your gist file is defined correctly, the image should be ready in a few minutes. It took me a few iterations to get this working with all the extensions I needed and shouldn&rsquo;t give you any errors during the build process.</p><ul><li>Login to your Dockerhub repo: <code>docker login</code></li><li>Push your image over to your repository: <code>docker push sriperinkulam/php-7.4.3-apache-buster-plus:latest</code></li><li>Within a few minutes, your image should be available for easy fetch whenever needed!</li></ul><p> </p><p><strong>Setting up and deploying the Known install</strong></p><ul><li>Create a folder for the known installation:</li></ul><p><code>sudo mkdir known && cd known</code></p><ul><li>Copy over my &lsquo;known.yml&rsquo; gist from <a href=https://gist.github.com/sriperinkulam/9ea9b57a052629ed5b75071c2bafdb00>here</a> and paste into a known.yml file.</li></ul><p><code>sudo nano known.yml</code></p><p>This is where we use the image we built earlier! Make sure you update the passwords there-in.</p><ul><li>Create an &lsquo;app&rsquo; folder. This is where we will copy in the core known package.</li></ul><p><code>sudo mkdir app && cd app</code></p><p><a href=https://www.marcus-povey.co.uk/known/>Marcus Povey</a> does the heavy lifting of packaging the known install &lsquo;unofficially&rsquo;. Download his latest pre-packaged release from <a href=https://withknown.marcus-povey.co.uk/>his portal</a>.</p><p><code>wget https://withknown.marcus-povey.co.uk/&lt;package></code></p><p>Finally unzip/untar the package.</p><ul><li>Step back into the main &lsquo;known&rsquo; directory and deploy the stack that we defined in the known.yml file.</li></ul><p><code>cd ..</code></p><p><code>DOMAIN=known.domain.org SCHEME=https docker stack deploy -c known.yml known</code></p><ul><li><p>Assuming you&rsquo;ve already setup the traefik container, as mentioned in my <a href=https://srikanthperinkulam.com/2020/04/19/self-hosting-jitsi-video-conferencing/>Jitsi post</a>, you should now have Known up and running. Navigate to the domain and you should see the warmup page.</p></li><li><p>Key in the db credentials that you setup in the <em>known.yml</em> file. The database would need to be set as <em>mariadb,</em> since that&rsquo;s how we&rsquo;ve defined it in the known.yml file. Also make sure you have the <em>Uploads</em> folder writable by www-data:</p></li></ul><p><code>sudo chown -R www-data /var/www/html/Uploads/</code></p><p>Setup your user account and proceed with the regular administration controls!</p></div><div class=comments><h3>💬 Comments</h3><script data-isso=https://isso.srikanthperinkulam.com/ data-isso-id=thread-id data-isso-css=true data-isso-lang=en data-isso-reply-to-self=true data-isso-reply-notifications=true data-isso-require-author=true data-isso-require-email=false data-isso-max-comments-top=10 data-isso-max-comments-nested=5 data-isso-reveal-on-click=5 data-isso-avatar=false data-isso-gravatar=true data-isso-feed=false data-isso-vote=true src=https://isso.srikanthperinkulam.com/js/embed.min.js></script><section id=isso-thread><noscript>Javascript needs to be activated to view comments.</noscript></section></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/docker-build/>Docker-Build</a></li><li><a href=http://localhost:1313/tags/docker-stack/>Docker-Stack</a></li><li><a href=http://localhost:1313/tags/idno/>Idno</a></li><li><a href=http://localhost:1313/tags/indieweb/>Indieweb</a></li><li><a href=http://localhost:1313/tags/known/>Known</a></li><li><a href=http://localhost:1313/tags/php/>Php</a></li><li><a href=http://localhost:1313/tags/withknown/>Withknown</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/2020/05/07/migrating-over-to-trilium-notes/><span class=title>« Prev</span><br><span>Migrating over to Trilium notes</span>
</a><a class=next href=http://localhost:1313/2020/04/24/weeknote-17-covid19-webmentions-and-migrations/><span class=title>Next »</span><br><span>Weeknote 17 - Covid19, Webmentions and Migrations</span></a></nav></footer><div class=comments id=comments></div><mastodon-comments host=chat.srkn.org user=ssp tootid=ZgotmplZ style="width : 1024px"></mastodon-comments><style>.comments{display:flex;flex-direction:column}.comment{display:flex;padding:10px;width:100%;flex-direction:column}.author .avatar{display:flex;align-self:flex-start;height:40px}.avatar img{border-radius:8px;width:40px;height:40px;align-self:flex-start}.author{width:100%;display:flex;flex-direction:row;align-self:flex-start;height:40px;margin-bottom:5px}.author .name{height:20px;padding-left:5px}.author .name .username{height:20px}.author .date{width:200px;height:20px}</style><script>const url="https://micro.blog/conversation.js?format=jsonfeed&url=http://localhost:1313/"+window.location.pathname;fetch(url).then(e=>e.json()).then(e=>{if(e.items.length===0)comments.innerHTML+="No webmentions yet..";else{const t=document.getElementById("comments");t.innerHTML+=e.items.map(e=>{const{author:{avatar:t,name:n,url:s},date_published:o,content_html:i}=e;return`
          <div class='comment'>
            <div class='author'>
              <div class='avatar'><img src="${t}" /></div>
              <div class='name'>
                <div class='username'><a href="${s}">${n}</a></div>
                <div class='date'>${new Date(o).toDateString()}</div>
              </div>
            </div>
            ${i}
          </div>
        `}).join("")}})</script><div id=webmentions></div></article></main><footer class=footer></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><footer class=footer><section class=h-card><a class="u-url u-uid" href=http://localhost:1313/><span class=p-name>Srikanth Perinkulam</span>
</a><span><img class=u-photo src=/images/favicon/favicon-32x32.png style=display:none alt></span>
<span class=p-note><br>Mountains, Family, Privacy and everything else.<br>Current location: <span class=p-locality>CDMX >> Cameroon.</span><br>Contact: <a class=u-url rel=me href=https://micro.blog/sp>Micro.blog</a> |
<a class=u-url rel=me href=https://chat.srkn.org/@ssp>Fediverse</a> |
<a class=u-url rel=me href=https://github.com/sriperinkulam>Github</a></span></section></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>