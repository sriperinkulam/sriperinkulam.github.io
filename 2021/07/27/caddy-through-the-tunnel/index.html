<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Caddy through the tunnel | Srikanth Perinkulam</title>
<meta name=keywords content="apache-guacamole,caddy,docker,navidrome,odroid-xu4,wireguard"><meta name=description content="Leave a comment if any of this doesn&rsquo;t make sense. I&rsquo;ll be more than happy to help.
I recently installed Navidrome on an Odroid XU4 and configured Guacamole on my NUC. To access these applications securely on an external network, I setup a WireGuard tunnel and took this opportunity to learn how to use Caddy as a reverse proxy. Here&rsquo;s a quick walk-through:


Setup the VPS:
Since we need a VPS just to tunnel traffic, get a lightweight one from a reliable provider. After the regular server hardening, setup your first WireGuard peer. I chose to use this script . "><meta name=author content="Srikanth Perinkulam"><link rel=canonical href=https://srikanthperinkulam.com/2021/07/27/caddy-through-the-tunnel/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://srikanthperinkulam.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://srikanthperinkulam.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://srikanthperinkulam.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://srikanthperinkulam.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://srikanthperinkulam.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://srikanthperinkulam.com/2021/07/27/caddy-through-the-tunnel/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Caddy through the tunnel"><meta property="og:description" content="Leave a comment if any of this doesn&rsquo;t make sense. I&rsquo;ll be more than happy to help.
I recently installed Navidrome on an Odroid XU4 and configured Guacamole on my NUC. To access these applications securely on an external network, I setup a WireGuard tunnel and took this opportunity to learn how to use Caddy as a reverse proxy. Here&rsquo;s a quick walk-through:


Setup the VPS:
Since we need a VPS just to tunnel traffic, get a lightweight one from a reliable provider. After the regular server hardening, setup your first WireGuard peer. I chose to use this script . "><meta property="og:type" content="article"><meta property="og:url" content="https://srikanthperinkulam.com/2021/07/27/caddy-through-the-tunnel/"><meta property="og:image" content="https://srikanthperinkulam.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-27T00:00:00+00:00"><meta property="article:modified_time" content="2021-07-27T00:00:00+00:00"><meta property="og:site_name" content="Srikanth Perinkulam"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://srikanthperinkulam.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Caddy through the tunnel"><meta name=twitter:description content="Leave a comment if any of this doesn&rsquo;t make sense. I&rsquo;ll be more than happy to help.
I recently installed Navidrome on an Odroid XU4 and configured Guacamole on my NUC. To access these applications securely on an external network, I setup a WireGuard tunnel and took this opportunity to learn how to use Caddy as a reverse proxy. Here&rsquo;s a quick walk-through:


Setup the VPS:
Since we need a VPS just to tunnel traffic, get a lightweight one from a reliable provider. After the regular server hardening, setup your first WireGuard peer. I chose to use this script . "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://srikanthperinkulam.com/posts/"},{"@type":"ListItem","position":2,"name":"Caddy through the tunnel","item":"https://srikanthperinkulam.com/2021/07/27/caddy-through-the-tunnel/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Caddy through the tunnel","name":"Caddy through the tunnel","description":"Leave a comment if any of this doesn\u0026rsquo;t make sense. I\u0026rsquo;ll be more than happy to help.\nI recently installed Navidrome on an Odroid XU4 and configured Guacamole on my NUC. To access these applications securely on an external network, I setup a WireGuard tunnel and took this opportunity to learn how to use Caddy as a reverse proxy. Here\u0026rsquo;s a quick walk-through:\nSetup the VPS:\nSince we need a VPS just to tunnel traffic, get a lightweight one from a reliable provider. After the regular server hardening, setup your first WireGuard peer. I chose to use this script . ","keywords":["apache-guacamole","caddy","docker","navidrome","odroid-xu4","wireguard"],"articleBody":"Leave a comment if any of this doesn’t make sense. I’ll be more than happy to help.\nI recently installed Navidrome on an Odroid XU4 and configured Guacamole on my NUC. To access these applications securely on an external network, I setup a WireGuard tunnel and took this opportunity to learn how to use Caddy as a reverse proxy. Here’s a quick walk-through:\nSetup the VPS:\nSince we need a VPS just to tunnel traffic, get a lightweight one from a reliable provider. After the regular server hardening, setup your first WireGuard peer. I chose to use this script . To route traffic from the external web, configure your DNS settings to point to the VPS and then setup haproxy on the VPS:\n## install haproxy sudo apt install haproxy -y ## setup the config sudo nano /etc/haproxy/haproxy.cfg Get the proxy config from my gist here and make sure you edit the IP address at the end. Once that is done, close out the file and restart the service:\n## check config haproxy -f /etc/haproxy/haproxy.cfg -c ## restart sudo systemctl restart haproxy.service With the above steps complete, you should have a WireGuard tunnel that’s ready to send traffic over to its peers.\nSetup your peers:\nInstall WireGuard on the device you’d like to connect to the external network. Since we’ve already setup the first peer [Server], we’ll just have to copy over the configs and update it for the other peers [clients]. There are quite a few guides out there that outline this. Happy to provide pointers if required. Once you the peer(s) up and running, make sure they can ’talk’ to each other :\nping -c 1 xx.xx.xx.xx\nGreat! Now we have the VPS and the WireGuard peers setup and talking to each other. Now on to routing the traffic. I would generally use Traefik for this. However, I wanted to explore caddy and this was a great test-case. I have docker containers running in DietPi on my Odroid-XU4. I spun up the caddy container using the below compose:\nversion: \"3\" networks: web: external: true services: caddy: image: caddy:2-alpine restart: unless-stopped ports: - \"80:80\" - \"443:443\" volumes: - /home/dietpi/caddy/Caddyfile:/etc/caddy/Caddyfile - /home/dietpi/caddy/data:/data - /home/dietpi/caddy/config:/config networks: - web And the Caddyfile below.\n{ # Global options block. Entirely optional, https is on by default # Optional email key for lets encrypt email updateme@domain.tld # Optional staging lets encrypt for testing. Comment out for production. # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory } app1.domain.tld { reverse_proxy containername:port } You’ll obviously have to tweak them for your needs. With all this set, you should now have functional access to your applications on the home-server externally!\nIt did take me a bit to figure out the moving parts. However, this was a fun exercise to tinker with caddy. Also I’ve been using the journal feature in Trilium to keep track of those hopping thoughts as I worked my way through setting this up. Tremendously useful! Questions or have a better way to set this up? I’m all ears!\n","wordCount":"500","inLanguage":"en","image":"https://srikanthperinkulam.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2021-07-27T00:00:00Z","dateModified":"2021-07-27T00:00:00Z","author":{"@type":"Person","name":"Srikanth Perinkulam"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://srikanthperinkulam.com/2021/07/27/caddy-through-the-tunnel/"},"publisher":{"@type":"Organization","name":"Srikanth Perinkulam","logo":{"@type":"ImageObject","url":"https://srikanthperinkulam.com/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://srikanthperinkulam.com/ accesskey=h title="Srikanth Perinkulam (Alt + H)"><img src=https://srikanthperinkulam.com/apple-touch-icon.png alt aria-label=logo height=35>Srikanth Perinkulam</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://srikanthperinkulam.com/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://srikanthperinkulam.com/categories/ title=categories><span>categories</span></a></li><li><a href=https://srikanthperinkulam.com/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://srikanthperinkulam.com/>Home</a>&nbsp;»&nbsp;<a href=https://srikanthperinkulam.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Caddy through the tunnel</h1><div class=post-meta><span title='2021-07-27 00:00:00 +0000 UTC'>July 27, 2021</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;500 words&nbsp;·&nbsp;Srikanth Perinkulam</div></header><div class=post-content><p><em>Leave a comment if any of this doesn&rsquo;t make sense. I&rsquo;ll be more than happy to help.</em></p><p>I recently installed <a href=https://srikanthperinkulam.com/2021/07/28/july-27-2021-2105/>Navidrome on an Odroid XU4</a> and configured <a href=https://srikanthperinkulam.com/2021/07/15/guacamole-clientless-remote-desktop-access/>Guacamole on my NUC</a>. To access these applications securely on an external network, I setup a WireGuard tunnel and took this opportunity to learn how to use Caddy as a reverse proxy. Here&rsquo;s a quick walk-through:</p><p><img loading=lazy src=images/image-2.png alt></p><p><strong>Setup the VPS:</strong></p><p>Since we need a VPS just to tunnel traffic, get a lightweight one from a reliable provider. After the regular server hardening, setup your first WireGuard peer. I chose to use <a href=https://github.com/angristan/wireguard-install>this script</a> . </p><p>To route traffic from the external web, configure your DNS settings to point to the VPS and then setup haproxy on the VPS:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## install haproxy</span>
</span></span><span class=line><span class=cl>sudo apt install haproxy -y
</span></span><span class=line><span class=cl><span class=c1>## setup the config</span>
</span></span><span class=line><span class=cl>sudo nano /etc/haproxy/haproxy.cfg
</span></span></code></pre></div><p>Get the proxy config from my <a href=https://gist.github.com/sriperinkulam/805cd86cd9ed797c8774d2331f135326>gist here</a> and make sure you edit the IP address at the end. Once that is done, close out the file and restart the service:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## check config</span>
</span></span><span class=line><span class=cl>haproxy -f /etc/haproxy/haproxy.cfg -c
</span></span><span class=line><span class=cl><span class=c1>## restart</span>
</span></span><span class=line><span class=cl>sudo systemctl restart haproxy.service
</span></span></code></pre></div><p>With the above steps complete, you should have a WireGuard tunnel that&rsquo;s ready to send traffic over to its peers.</p><p><strong>Setup your peers:</strong></p><p>Install WireGuard on the device you&rsquo;d like to connect to the external network. Since we&rsquo;ve already setup the first peer [Server], we&rsquo;ll just have to copy over the configs and update it for the other peers [clients]. There are quite a few guides out there that outline this. Happy to provide pointers if required. Once you the peer(s) up and running, make sure they can &rsquo;talk&rsquo; to each other :</p><p><code>ping -c 1 xx.xx.xx.xx</code></p><p>Great! Now we have the VPS and the WireGuard peers setup and talking to each other. Now on to routing the traffic. I would generally use Traefik for this. However, I wanted to explore caddy and this was a great test-case. I have docker containers running in DietPi on my Odroid-XU4. I spun up the caddy container using the below compose:</p><pre tabindex=0><code>version: &#34;3&#34;

networks:
        web:
                external: true
services:
        caddy:
                image: caddy:2-alpine
                restart: unless-stopped
                ports:
                        - &#34;80:80&#34;
                        - &#34;443:443&#34;
                volumes:
                        - /home/dietpi/caddy/Caddyfile:/etc/caddy/Caddyfile
                        - /home/dietpi/caddy/data:/data
                        - /home/dietpi/caddy/config:/config
                networks:
                        - web
</code></pre><p>And the Caddyfile below.</p><pre tabindex=0><code>{
    # Global options block. Entirely optional, https is on by default
    # Optional email key for lets encrypt
    email updateme@domain.tld 
    # Optional staging lets encrypt for testing. Comment out for production.
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}
app1.domain.tld {
    reverse_proxy containername:port
}
</code></pre><p> You&rsquo;ll obviously have to tweak them for your needs. With all this set, you should now have functional access to your applications on the home-server externally!</p><p>It did take me a bit to figure out the moving parts. However, this was a fun exercise to tinker with caddy. Also I&rsquo;ve been using the <a href=https://pixel.srkn.org/p/sriperinkulam/321094300853211136>journal feature in Trilium</a> to keep track of those hopping thoughts as I worked my way through setting this up. Tremendously useful! Questions or have a better way to set this up? I&rsquo;m all ears!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://srikanthperinkulam.com/tags/apache-guacamole/>Apache-Guacamole</a></li><li><a href=https://srikanthperinkulam.com/tags/caddy/>Caddy</a></li><li><a href=https://srikanthperinkulam.com/tags/docker/>Docker</a></li><li><a href=https://srikanthperinkulam.com/tags/navidrome/>Navidrome</a></li><li><a href=https://srikanthperinkulam.com/tags/odroid-xu4/>Odroid-Xu4</a></li><li><a href=https://srikanthperinkulam.com/tags/wireguard/>Wireguard</a></li></ul><nav class=paginav><a class=prev href=https://srikanthperinkulam.com/2021/07/30/july-30-2021-1124/><span class=title>« Prev</span><br><span>July 30, 2021 11:24</span>
</a><a class=next href=https://srikanthperinkulam.com/2021/07/27/july-27-2021-2105/><span class=title>Next »</span><br><span>July 27, 2021 21:05</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://srikanthperinkulam.com/>Srikanth Perinkulam</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>